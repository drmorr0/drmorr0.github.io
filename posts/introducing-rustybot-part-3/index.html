<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Introducing Rustybot (part 3 of n)" /><meta name="author" content="drmorr" /><meta property="og:locale" content="en_US" /><meta name="description" content="N.B. This is the third part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here." /><meta property="og:description" content="N.B. This is the third part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here." /><link rel="canonical" href="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/" /><meta property="og:url" content="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/" /><meta property="og:site_name" content="Object Disoriented" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-26T23:31:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Introducing Rustybot (part 3 of n)" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/","dateModified":"2021-02-26T23:31:00-08:00","datePublished":"2021-02-26T23:31:00-08:00","headline":"Introducing Rustybot (part 3 of n)","mainEntityOfPage":{"@type":"WebPage","@id":"https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/"},"author":{"@type":"Person","name":"drmorr"},"description":"N.B. This is the third part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here.","@context":"https://schema.org"}</script><title>Introducing Rustybot (part 3 of n) | Object Disoriented</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/robot.svg" alt="this robot is confused" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Object Disoriented</a></div><div class="site-subtitle font-italic">When OOP becomes OOPS</div><div class="site-about">Building robots with Rust. Navel-gazing about tech. Doing buzzwords on Kubernetes.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/drmorr0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['drmorr','evokwonder.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Introducing Rustybot (part 3 of n)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Introducing Rustybot (part 3 of n)</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Feb 26, 2021, 11:31 PM -0800" > Feb 26 <i class="unloaded">2021-02-26T23:31:00-08:00</i> </span> by <span class="author"> drmorr </span></div></div><div class="post-content"><blockquote><p>N.B. This is the third part of a series about programming an Arduino robot using Rust’s async primitives (Part <a href="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-1/">1</a>, <a href="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/">2</a>, 3). If you just want to skip to the source code, click <a href="https://github.com/drmorr0/rustybot">here</a>.</p></blockquote><h2 id="now-were-cooking-with-gas">Now we’re cooking with gas</h2><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/XEINWA0DF6KRAZ0APL/giphy.gif" /><figcaption>Yep. Definitely cooking with gas.</figcaption></figure></details><p>So I’ve made some significant progress since my last update. The first thing to point out is that I got a <a href="https://www.microchip.com/Developmenttools/ProductDetails/ATATMEL-ICE">hardware debugger</a>. For reasons that will become clear shortly, the primitive debugging techniques I outlined in my last post went from “annoying but workable” to “no longer actually possible.” I was also pleased to see that the ATMEL-ICE debugger supports various Cortex ARM processors, which I am anticipating migrating to at some point in the future. And, that purchase has already paid off massively! The only downside is that it means my toolchain is a little less convenient, and I have to spend more time in Atmel Studio, which I don’t love, but whatever, it’s fine.</p><p>That said, the purchase of the ATMEL-ICE prompted a bunch of <em>other</em> purchases which I’ve been putting off for a while and didn’t <em>really</em> want to make right now. See, the ICSP connector (which the debugger attaches to) on the Arduino board sticks out the top of the board, and the board gets mounted upside-down on the Zumo robot. Which means that I can’t actually plug the debugger in while the board was attached to the robot—kinda defeating the point. So, I swapped the connector around so it sticks out the other side. Yay! But, I managed to make a total hash of the board because my soldering iron tip was too large. Boo. Fortunately everything still works. Yay! But, well, it ain’t pretty.</p><p>So I caved and bought a set of smaller tips for my soldering iron, along with a few other components that’ll come in handy down the line. But anyways, let’s not focus on my soldering incompetence any longer, and instead focus on my programming incompetence!</p><h2 id="a-laundry-list-of-stupid-mistakes-ive-made">A laundry list of stupid mistakes I’ve made</h2><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/9jObH9PkVPTyM/giphy.gif" /><figcaption>I'm sure this is the only time he says this, right?</figcaption></figure></details><p>Having already identified two compiler bugs with Rust’s AVR support, it made every <em>other</em> bug that I found that much harder to troubleshoot, since I didn’t trust the underlying system. So let’s play a fun game! I’m going to write down a list of bugs and for each one you have to guess whether it’s a compiler bug or not. Ready? Let’s go!</p><ol><li>After I worked through all the various compiler bugs and finally got my async executor working with one <code class="language-plaintext highlighter-rouge">Future</code> (one that just blinked the LED), I tried to add a second <code class="language-plaintext highlighter-rouge">Future</code> into the mix. Weirdly, adding a second future object caused everything to panic. I spent a long time tracing through the assembly trying to understand what was happening, and it seemed like the creation of the second <code class="language-plaintext highlighter-rouge">Future</code> was wiping out all the data for the first one. I finally tracked the problem down to the line where I called <code class="language-plaintext highlighter-rouge">Allocator::get().new(future2)</code> (<code class="language-plaintext highlighter-rouge">Allocator</code> is my custom bump allocator implementation, and <code class="language-plaintext highlighter-rouge">get()</code> is supposed to return a pointer to the singleton allocator object). Then I realized that my implementation looked like this:<div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">impl</span> <span class="n">Allocator</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="k">mut</span> <span class="n">Allocator</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">ALLOCATOR_INITIALIZED</span> <span class="p">{</span>
           <span class="n">ALLOCATOR</span> <span class="o">=</span> <span class="n">Allocator</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">&amp;</span><span class="n">ALLOCATOR</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Which, if you’ll observe, never sets the <code class="language-plaintext highlighter-rouge">ALLOCATOR_INITIALIZED</code> variable, so I was re-zeroing out my “fake heap” space every time I created a new future. Verdict: <strong>not</strong> a compiler error.</p><li>After I solved that issue, I had a different weird issue occur with two futures. The first future was again set to blink an LED, and the second was supposed to control the motor. What actually happened was that the LED was blinking at weird, inconsistent frequencies. In fact, the LED was toggling whenever the first <em>or</em> the second future woke up! This one stumped me for quite a while, and then I realized that the problem was in this block of code:<div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.work_queue_len</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="k">self</span><span class="py">.work_queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">waker</span> <span class="o">=</span> <span class="nn">Waker</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="nn">RawWaker</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="mi">_</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="mi">_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VTABLE</span><span class="p">));</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">ctx</span> <span class="o">=</span> <span class="nn">Context</span><span class="p">::</span><span class="nf">from_waker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waker</span><span class="p">);</span>
        <span class="nn">Pin</span><span class="p">::</span><span class="nf">new_unchecked</span><span class="p">(</span><span class="k">self</span><span class="py">.drivers</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="nf">.assume_init_mut</span><span class="p">())</span><span class="nf">.poll</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">ctx</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The issue here is that <code class="language-plaintext highlighter-rouge">&amp;id</code> pointer. Whatever it’s pointing to is obviously going to get overwritten when the for-loop goes out of scope, and actually as I’m writing this, I’m having a bit of trouble reconstructing how this code resulted in the exact failure mode I observed, but the short version is that every future ended up holding a pointer to the same address location, which was the id for the LED’s future. Hence, the LED blinked a bunch. Verdict: <strong>not</strong> a compiler bug.</p><li>I don’t totally remember at what point I discovered this bug, but at one point I was allocating 1KB of my internal RAM for my “fake heap”, which was causing me to overflow my stack semi-regularly. The Arduino only <em>has</em> 2KB of RAM, and I certainly didn’t need that much for my futures, but it took me a while to realize what was going on. Verdict: <strong>not</strong> a compiler bug.<li>This is actually related to the previous bug, but I’d been observing weird issues regularly with <code class="language-plaintext highlighter-rouge">ufmt</code>. It appeared to just randomly panic whenever I tried to write out data to the serial port. There was also all this weird gibberish that was getting dumped into SRAM and taking up a ton of space (like, all the characters of the alphabet, plus lots of random other characters). It took me a <em>very long time</em> to connect the dots here—if you have a formatting library, it has to have all the characters it needs to format things loaded into memory somewhere, and there are a lot of characters. I also suspect (but haven’t verified) that <code class="language-plaintext highlighter-rouge">ufmt</code> has to make a lot of nested function calls to actually succeed at formatting things correctly, which would cause it to overflow the stack and panic. I didn’t actually think this was a compiler bug, but I <em>did</em> think that <code class="language-plaintext highlighter-rouge">ufmt</code> was a buggy library for quite a while; I’m a bit embarrased at how long it took me to figure out the actual problem. I ended up just deleting that dependency, because I’m not gonna have my robot hooked up to a USB cable while it’s driving around anyways. Verdict: <strong>not</strong> a compiler (or a library) bug.</ol><h2 id="motors-and-ir-sensors-and-magnetometers-oh-my">Motors and IR sensors and magnetometers, oh my!</h2><p>For the rest of this post, I’m going to talk briefly about each of the various components that I have working on the robot, and mention any pitfalls or gotchas that came up along the way.</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/N8wR1WZobKXaE/giphy.gif" /><figcaption>DARPA TV? More like <i>DERP</i>A TV, amirite?</figcaption></figure></details><h3 id="the-motor-controllers">The motor controllers</h3><p>The motors were the first non-LED component that I got working with my async code, and it took me a little while to figure out the right way to structure the code for these more complex futures. For a long while, I had a <code class="language-plaintext highlighter-rouge">MotorController</code> struct that had almost no data or methods, and then a function that would take a pointer to a <code class="language-plaintext highlighter-rouge">MotorController</code> as its first argument and then return the future. The motor future itself was a closure with a bunch of state that was “local” to the function that defined it:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">MotorController</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">left_target</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">right_target</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_motor_driver</span><span class="p">(</span>
    <span class="n">controller_ref</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="n">MotorController</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">mut</span> <span class="n">left_direction_pin</span><span class="p">:</span> <span class="n">PB0</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">mut</span> <span class="n">left_throttle_pin</span><span class="p">:</span> <span class="n">PB2</span><span class="o">&lt;</span><span class="n">Pwm</span><span class="o">&lt;</span><span class="nn">pwm</span><span class="p">::</span><span class="n">Timer1Pwm</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">mut</span> <span class="n">right_direction_pin</span><span class="p">:</span> <span class="n">PD7</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">mut</span> <span class="n">right_throttle_pin</span><span class="p">:</span> <span class="n">PB1</span><span class="o">&lt;</span><span class="n">Pwm</span><span class="o">&lt;</span><span class="nn">pwm</span><span class="p">::</span><span class="n">Timer1Pwm</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="k">mut</span> <span class="n">dyn</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span> <span class="o">=</span> <span class="o">!&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">current_left_value</span><span class="p">:</span> <span class="nb">f32</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">current_right_value</span><span class="p">:</span> <span class="nb">f32</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">future</span> <span class="o">=</span> <span class="k">async</span> <span class="k">move</span> <span class="p">||</span> <span class="p">{</span>
        <span class="k">loop</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="o">=</span> <span class="n">controller_ref</span><span class="nf">.try_borrow</span><span class="p">()</span> <span class="p">{</span>
                <span class="c">// Move the current value closer to the target value in here</span>
            <span class="p">}</span>
            <span class="nn">Waiter</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">UPDATE_DELAY_MS</span><span class="p">)</span><span class="k">.await</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nn">Allocator</span><span class="p">::</span><span class="nf">get</span><span class="p">()</span><span class="nf">.new</span><span class="p">(</span><span class="nf">future</span><span class="p">())</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Eventually I decided that this was a less-than-ideal way to structure things, so I moved the <code class="language-plaintext highlighter-rouge">current_left/right_value</code> fields into the <code class="language-plaintext highlighter-rouge">MotorController</code> object. Unfortunately, this prevented the motors from ever turning on, because of that pesky <code class="language-plaintext highlighter-rouge">RefCell</code> – essentially, both the controller and the state machine were trying to write to the <code class="language-plaintext highlighter-rouge">RefCell</code> at the same time, which is forbidden. So then I finally figured out how to restructure things so that I didn’t have to use the <code class="language-plaintext highlighter-rouge">RefCell</code>, and then I could make the <code class="language-plaintext highlighter-rouge">get_motor_driver</code> function an actual method on the <code class="language-plaintext highlighter-rouge">MotorController</code> object, which takes a <code class="language-plaintext highlighter-rouge">static</code> pointer to <code class="language-plaintext highlighter-rouge">self</code>. The big breakthrough here was that the <code class="language-plaintext highlighter-rouge">MotorController</code> needed <em>separate</em> <code class="language-plaintext highlighter-rouge">RefCell</code>s which behave like a poor-man’s version of “channels” in Golang:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">MotorController</span> <span class="p">{</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="n">SingleMotorController</span><span class="o">&lt;</span><span class="n">LeftDirectionPin</span><span class="p">,</span> <span class="n">LeftThrottlePin</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">left_target</span><span class="p">:</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="n">SingleMotorController</span><span class="o">&lt;</span><span class="n">RightDirectionPin</span><span class="p">,</span> <span class="n">RightThrottlePin</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">right_target</span><span class="p">:</span> <span class="n">RefCell</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The target values are only ever <em>written to</em> by my state machine “brain”, and only ever <em>read</em> by the <code class="language-plaintext highlighter-rouge">MotorController</code>. The actual motor values themselves are only read and written to by the <code class="language-plaintext highlighter-rouge">MotorController</code>, so I can ensure that they aren’t being borrowed mutably twice.</p><h3 id="the-ir-sensors">The IR sensors</h3><p>My initial pass at getting the IR sensors to work was just a straight port of the <a href="https://github.com/pololu/zumo-shield-arduino-library/blob/master/QTRSensors.cpp">code provided for the Zumo</a>. When I then went to convert it to an async version, I ran into problems because the sensor read time happens on the order of microseconds, but my async executor’s minimum resolution was in milliseconds. I <em>could</em> block the executor for a millisecond or two while I read the IR sensors, but that kinda went against the entire spirit of this project; and plus, I wasn’t too sure how that would mess with the timings (which are clearly not too important for this robot, but will be important for my quadcopter).</p><p>The first thing I tried here was changing the resolution of the async executor to be microseconds instead of milliseconds, but this failed horribly. Timings were completely off, cycles were getting dropped, it was just all over the place. My suspicion is that microsecond resolution is just too fine for this processor. Conceivably maybe we could get away with something like 100-μs resolution, but that was starting to get too complicated and it still didn’t solve my problem with the IR sensor array.</p><p>After some conversation with a friend, and a re-reading of the AVR spec, I finally figured out how to do this. It turns out that you can enable per-pin interrupts when the value on the pin changes. So to read the IR sensors, I do the following:</p><ol><li>Drive the IR sensors high<li>Record the “start time” for reading the sensors<li>Enable the per-pin interrupts; when these ISRs fire, they record the number of microseconds since we started (which directly correlates with the brightness of the surface the sensors are over).<li>Wait (asynchronously) a couple milliseconds<li>Read the final values out from the sensor array</ol><p>Et voilà! We can keep our millisecond-resolution executor and record microsecond-resolution values from our sensors!</p><h3 id="the-imu">The IMU</h3><p>If you recall, the Zumo has an inertial measurement unit (IMU), which consists of a 3-axis magnetometer along with an accelerometer. Getting this working was another pretty straight translation from the <a href="https://github.com/pololu/zumo-shield-arduino-library/blob/master/ZumoIMU.cpp">provided C code</a>; I guess to be clear, I haven’t gotten the accelerometer working yet because I haven’t needed it thus far.</p><p>The most challenging bit here was learning how the TWI (two-wire interface, pronounced “TWEEEEEEE”, obviously) works on the Arduino. It also took me a bit of time to understand how the <a href="https://rahix.github.io/avr-hal/arduino_uno/type.I2cMaster.html">Rust interface with the TWI</a> works in <code class="language-plaintext highlighter-rouge">avr-hal</code>. It was at this point that I realized I needed to update the version of <code class="language-plaintext highlighter-rouge">avr-hal</code> I was using, which changed some dependencies, which required me to rebuild my <code class="language-plaintext highlighter-rouge">rustc</code> toolchain, which resulted in my <a href="https://objectdisoriented.evokewonder.com/posts/patching-llvm/">last post</a>. For the want of a nail, and all that jazz.</p><h3 id="eeprom">EEPROM</h3><p>In actuality, the EEPROM was the earliest thing I got working with my Arduino board, well before I started doing any robotics; until now I hadn’t figured out a good use for it, but both the IR sensors and the IMU need some calibration data to work effectively, so I dug up my old code and dropped it in so that I can store my calibration data in the EEPROM and not have to re-calibrate every time I turn the robot on. The only thing I dislike about this bit is that my EEPROM address map is just a long list of constant values; it seems like there ought to be a better way to encode this, but I haven’t figured it out yet.</p><p>So that’s it! Everything I’ve gotten working on the robot so far! In my next post, I will talk about the state machine “brain” of the robot, along with some concerns I have for using a lot of async code in an embedded project.</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/3oriff8rzy11Laah2g/giphy.gif" /><figcaption>I can neither confirm nor deny whether my robot is using the brain of Homer Simpson.</figcaption></figure></details><p>Thanks for reading,</p><p>~drmorr</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/rust/" class="post-tag no-text-decoration" >rust</a> <a href="/tags/robots/" class="post-tag no-text-decoration" >robots</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Introducing Rustybot (part 3 of n) - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Introducing Rustybot (part 3 of n) - Object Disoriented&u=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Introducing Rustybot (part 3 of n) - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/introducing-rustybot-part-1/">Introducing Rustybot (part 1 of n)</a><li><a href="/posts/introducing-rustybot-part-2/">Introducing Rustybot (part 2 of n)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/llvm/">llvm</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/introducing-rustybot-part-1/"><div class="card-body"> <span class="timeago small" > Dec 21, 2020 <i class="unloaded">2020-12-21T23:30:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 1 of n)</h3><div class="text-muted small"><p> N.B. This is the first part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here. So you want ...</p></div></div></a></div><div class="card"> <a href="/posts/introducing-rustybot-part-2/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2021-01-04T23:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 2 of n)</h3><div class="text-muted small"><p> N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here. PSA: click o...</p></div></div></a></div><div class="card"> <a href="/posts/patching-llvm/"><div class="card-body"> <span class="timeago small" > Jan 9 <i class="unloaded">2021-01-09T19:23:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Patching LLVM and rustc</h3><div class="text-muted small"><p> This post is just an aside; As I mentioned in my last post, there is a compiler bug in LLVM that is resulting in incorrect code being generated for AVR with Rust. I made some vague assertions in a...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/patching-llvm/" class="btn btn-outline-primary"><p>Patching LLVM and rustc</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://evokewonder.com">David R. Morrison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/llvm/">llvm</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://objectdisoriented.evokewonder.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
