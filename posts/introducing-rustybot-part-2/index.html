<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Introducing Rustybot (part 2 of n)" /><meta name="author" content="drmorr" /><meta property="og:locale" content="en_US" /><meta name="description" content="N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part 1, 2). If you just want to skip to the source code, click here." /><meta property="og:description" content="N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part 1, 2). If you just want to skip to the source code, click here." /><link rel="canonical" href="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/" /><meta property="og:url" content="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/" /><meta property="og:site_name" content="Object Disoriented" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-04T23:00:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Introducing Rustybot (part 2 of n)" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/","dateModified":"2021-01-04T23:00:00-08:00","datePublished":"2021-01-04T23:00:00-08:00","headline":"Introducing Rustybot (part 2 of n)","mainEntityOfPage":{"@type":"WebPage","@id":"https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/"},"author":{"@type":"Person","name":"drmorr"},"description":"N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part 1, 2). If you just want to skip to the source code, click here.","@context":"https://schema.org"}</script><title>Introducing Rustybot (part 2 of n) | Object Disoriented</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/robot.svg" alt="this robot is confused" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Object Disoriented</a></div><div class="site-subtitle font-italic">When OOP becomes OOPS</div><div class="site-about">Building robots with Rust. Navel-gazing about tech. Doing buzzwords on Kubernetes.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/drmorr0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['drmorr','evokwonder.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Introducing Rustybot (part 2 of n)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Introducing Rustybot (part 2 of n)</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 4, 2021, 11:00 PM -0800" > Jan 4 <i class="unloaded">2021-01-04T23:00:00-08:00</i> </span> by <span class="author"> drmorr </span></div></div><div class="post-content"><blockquote><p>N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part <a href="https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-1/">1</a>, 2). If you just want to skip to the source code, click <a href="https://github.com/drmorr0/rustybot">here</a>.</p></blockquote><h2 id="psa-click-on-all-the-things">PSA: click on all the things</h2><p>Ok, one bit of housekeeping first: a few people complained that the animated GIFs from the last post were distracting and made it hard to read, which, as much as I hate to admit it, is actually a fair complaint. Instead of getting rid of them entirely, I’ve started sticking them in collapsible elements so that you don’t get completely overwhelmed by my wit and brilliance. Like this:</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/kFgzrTt798d2w/giphy.gif" /><figcaption>C'mon, you didn't seriously expect anything other than this, did you?</figcaption></figure></details><p>I guess you <em>could</em> also just skip over those elements entirely since there’ll never be anything important in there, but really—where’s the fun in that???</p><p>Alrighty then, with that out of the way, let’s jump back in where we left off. Which was, uhh… hmmm…</p><h2 id="what-were-we-doing-again">What were we doing, again?</h2><p>In the last post, we discussed the setup for this project, some of the basics of asynchronous programming with Rust, and how to get that all working on an Arduino. We ended the post talking about <code class="language-plaintext highlighter-rouge">Future</code> objects, which if you recall, have a single function that they <em>promise</em> (see what I did there? eh? eh??) to implement:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span>
    <span class="k">mut</span> <span class="k">self</span><span class="p">:</span> <span class="nn">core</span><span class="p">::</span><span class="nn">pin</span><span class="p">::</span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span> <span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span> 
    <span class="n">ctx</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">core</span><span class="p">::</span><span class="nn">task</span><span class="p">::</span><span class="n">Context</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">core</span><span class="p">::</span><span class="nn">task</span><span class="p">::</span><span class="n">Poll</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Output</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>As a reminder, <em>every</em> asynchronous operation in Rust boils down to a <code class="language-plaintext highlighter-rouge">Future</code>; when you use the <code class="language-plaintext highlighter-rouge">async</code>/<code class="language-plaintext highlighter-rouge">await</code> keywords, these are just some syntactic sugar that instruct the compiler on how to build an internal state-machine representation of your future. We also talked about the two arguments to this function and implications they had for writing asynchronous code on AVR, but there’s still one piece left that we need to discuss: the return value.</p><p>Futures can obviously return all kinds of different values, depending on the application, so each <code class="language-plaintext highlighter-rouge">Future</code> needs to specify what the type is for the value it will eventually return. For my purposes, I’m not expecting my futures to <em>ever</em> return – each one is just a control loop for a different component in the robot. So each of my futures has a fully-qualified type of <code class="language-plaintext highlighter-rouge">core::future::Future&lt;Output = !&gt;</code>, which (at time of writing) uses an unstable Rust feature, so I have to stick</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nd">#![feature(never_type)]</span>
</pre></table></code></div></div><p>at the top of my <code class="language-plaintext highlighter-rouge">main.rs</code> file. But what the heck, this entire robot is built using nightly/unstable features, what’s one more to throw into the mix?</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/3o6Zt6eQnQ8UUPhV60/giphy.gif" /><figcaption>This guy has a very smart-looking goatee, he seems quite trustworthy</figcaption></figure></details><p>Now, the actual return type of the future is a <code class="language-plaintext highlighter-rouge">core::task::Poll</code> enum, which has two possible variants: <code class="language-plaintext highlighter-rouge">Pending</code>, and <code class="language-plaintext highlighter-rouge">Ready(T)</code>, where <code class="language-plaintext highlighter-rouge">T</code> is just the type of <code class="language-plaintext highlighter-rouge">Self::Output</code>. The idea is this: the executor can use literally whatever method it wants to poll the futures (including just a dumb busy-loop), and if the future is still waiting or has more work to do, the executor will get back <code class="language-plaintext highlighter-rouge">Pending</code>, but if the future has completed, then it will get back a <code class="language-plaintext highlighter-rouge">Ready</code> value that encapsulates the actual value returned by the function. But in this case, we don’t actually care about the <code class="language-plaintext highlighter-rouge">Ready</code> value, because we “know” that the futures will never return; so my executor just throws away the return value from <code class="language-plaintext highlighter-rouge">poll</code>:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="mi">_</span> <span class="o">=</span> <span class="n">future</span><span class="nf">.poll</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">ctx</span><span class="p">);</span>
</pre></table></code></div></div><p>To summarize, each of my robot components is controlled by a <code class="language-plaintext highlighter-rouge">Future</code> with the following form:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="n">future</span> <span class="o">=</span> <span class="k">async</span> <span class="k">move</span> <span class="p">||</span> <span class="p">{</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="c">// do stuff</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><p>But what is actually going on inside that cryptically-labelled <code class="language-plaintext highlighter-rouge">do stuff</code> block???</p><h2 id="time-for-a-compiler-bug">Time for a compiler bug!</h2><p>To answer that question, let’s take a look at the <code class="language-plaintext highlighter-rouge">Future</code> object that underlies all of my control loops. It’s called a <code class="language-plaintext highlighter-rouge">Waiter</code>, and its job (as you might expect) is to wait until a certain amount of time has passed. It’s pretty simple, so I’m just going to paste the whole code here:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">Waiter</span> <span class="p">{</span>
    <span class="n">trigger_time_ms</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">interrupt_set</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Future</span> <span class="k">for</span> <span class="n">Waiter</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Output</span> <span class="o">=</span> <span class="p">();</span>

    <span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">:</span> <span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span> <span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Context</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Poll</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Output</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">millis</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">self</span><span class="py">.trigger_time_ms</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.interrupt_set</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">return</span> <span class="nn">Poll</span><span class="p">::</span><span class="nf">Ready</span><span class="p">(());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="k">self</span><span class="py">.interrupt_set</span> <span class="p">{</span>
            <span class="nf">register_timed_waker</span><span class="p">(</span><span class="k">self</span><span class="py">.trigger_time_ms</span><span class="p">,</span> <span class="n">ctx</span><span class="nf">.waker</span><span class="p">()</span><span class="nf">.clone</span><span class="p">());</span>
            <span class="k">self</span><span class="py">.interrupt_set</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nn">Poll</span><span class="p">::</span><span class="n">Pending</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The first thing to notice is that <code class="language-plaintext highlighter-rouge">Waiter</code> actually <em>does</em> return, once the elapsed time has passed, so it has a return type of <code class="language-plaintext highlighter-rouge">()</code> instead of <code class="language-plaintext highlighter-rouge">!</code>. The way that it works is pretty simple; when you instantiate a new <code class="language-plaintext highlighter-rouge">Waiter</code>, you provide a time in milliseconds<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup> when you want it to expire. The first time you call <code class="language-plaintext highlighter-rouge">poll</code> (as long as the expiration time hasn’t already passed), we simply call <code class="language-plaintext highlighter-rouge">register_timed_waker</code>, which sets up an interrupt to fire when the trigger time has passed. Every subsequent time you call <code class="language-plaintext highlighter-rouge">poll</code>, it returns <code class="language-plaintext highlighter-rouge">Pending</code>, unless we’ve passed the trigger time, and then we return <code class="language-plaintext highlighter-rouge">Ready</code>. Pretty straightforward, right?</p><p>Of course not. Nothing about this is straightforward. Why would you think otherwise?</p><p>I’m going to skip over the details of <code class="language-plaintext highlighter-rouge">register_timed_waker</code> and the interrupt routine for now (though I may come back to this in a later post), because there’s a fundamental bug in the Rust compiler that prevents this whole thing from working. I first read about this on <a href="https://lights0123.com/blog/2020/07/25/async-await-for-avr-with-rust/#to-do">Ben Schattinger’s blog</a>, so I at least knew about it ahead of time, but decided to go ahead and try it out for myself anyways. Maybe it would magically work for me (spoiler warning: it did not).</p><p>The gist of the bug is that (if you recall from my first post), at the bottom of this <code class="language-plaintext highlighter-rouge">Context/Waker/RawWaker</code> stack is a virtual function pointer table that we have to use in order to tell the executor what tasks need to be woken up. These function pointers get translated into an <code class="language-plaintext highlighter-rouge">icall</code> (indirect call) assembly instruction, which takes as its only argument a memory location containing the address of the function that should be called. And (as it stands right at the time of writing) LLVM generates this function address incorrectly, meaning that instead of jumping to the start of the function, the program counter jumps to somewhere the middle of the function. As you might imagine, this completely corrupts your program state and causes everything to panic.</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/An4MkAbxeiyqY/giphy.gif" /><figcaption>Don't panic!</figcaption></figure></details><p>This might have sunk the entire project right here, except that the fix is fairly straightforward and there is a <a href="https://reviews.llvm.org/D87631">patch</a> already in existence. Reading through the review comments there, most of the issues are with the tests and not the code itself; after <a href="https://gitter.im/avr-rust/Lobby?at=5f8693701cbba72b63dc44d5">chatting with the developers</a> I decided the easiest course of action would be to just apply the patch to a custom Rust toolchain. I mean honestly, how hard could that be?</p><p>Actually not that hard! The only real gotcha was that Rust bundles its own copy of LLVM which includes a few language-specific optimizations, instead of relying on the upstream version of LLVM. So I first cloned LLVM and the patch didn’t apply cleanly, and then I did some more reading, and then cloned the <a href="https://github.com/rust-lang/llvm-project/tree/8d78ad13896b955f630714f386a95ed91b237e3d">Rust version of LLVM</a>, to which the patch applied cleanly, I built it, and I was off and running!<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></p><h2 id="time-for-another-compiler-bug">Time for another compiler bug!</h2><p>So—what have we accomplished so far? We’ve made some <code class="language-plaintext highlighter-rouge">Future</code>s, we’ve set them up to trigger when a timer expires, we’ve patched LLVM so that the function pointers work correctly; now, we just need to tell our executor to wake up the tasks. Seems like it shouldn’t be too hard, right<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>? No, but there are lots of little gotchas along the way. Let’s look at the function that gets called when we want to wake a future up:</p><div class="language-rust highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">wake</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">*</span><span class="k">const</span> <span class="p">())</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="nn">Executor</span><span class="p">::</span><span class="nf">get</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">data</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="nb">usize</span><span class="p">);</span>
    <span class="n">e</span><span class="nf">.add_work</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Remember that <code class="language-plaintext highlighter-rouge">wake</code> is being called from an interrupt context. The idea here is that the interrupt gets a pointer to the (singleton) <code class="language-plaintext highlighter-rouge">Executor</code> object, and then tells the executor that the future needs to wake up. If you recall from part one of this series, the <code class="language-plaintext highlighter-rouge">data</code> argument is just the value that’s been encased in 4 layers of indirection inside the <code class="language-plaintext highlighter-rouge">Context</code> object—in this case, the <code class="language-plaintext highlighter-rouge">id</code> of the future. The <code class="language-plaintext highlighter-rouge">add_work</code> function is simply telling the executor that the future with that ID needs to wake up and do something.</p><p>Now, some details about the executor: the futures are all stored in an array, and the futures’ IDs are just an index into that array. So when the executor’s run-loop spins back around, it’ll see that ID present in some kind of data structure and then use it to <code class="language-plaintext highlighter-rouge">poll</code> the corresponding entry in the futures array. So far so good; but, there’s actually a few different implementation choices we need to make here that potentially could make things complicated. Specifically, how should we represent the “list of futures that need to be polled”? The naïve solution is to stick the IDs in a <code class="language-plaintext highlighter-rouge">Vec</code> and call it a day—the executor could just pop everything off the vector in every iteration.</p><p>So I tried doing that here, using the <a href="https://docs.rs/heapless/0.5.6/heapless/"><code class="language-plaintext highlighter-rouge">heapless</code></a> implementation of <code class="language-plaintext highlighter-rouge">Vec</code>; essentially, the API is the same as what’s in <code class="language-plaintext highlighter-rouge">std</code>, except that you have to declare at compile time what the maximum size of your vector is, and you’re not ever allowed to grow beyond that size. So I wired everything up, turned it on, and… immediately got a panic. It took a bit of digging to discover why, but I <em>believe</em> it’s another <a href="https://github.com/rust-lang/rust/issues/78260">compiler/code generation bug</a>. You can go read the bug report for the details, but the short version is as follows:</p><p>Whenever a <code class="language-plaintext highlighter-rouge">call</code> or <code class="language-plaintext highlighter-rouge">icall</code> instruction is encountered, the processor is entering a new function context, and all the CPU registers and other state needs to be saved onto the stack so that when the function call returns it can pick up where it left off. This is done with a sequence of <code class="language-plaintext highlighter-rouge">push</code> instructions at the start of every subroutine, and a sequence of <code class="language-plaintext highlighter-rouge">pop</code> instructions at the end. The naïve way to do this is to just <code class="language-plaintext highlighter-rouge">push</code> <em>every</em> register, but this is a waste of time and stack space, since many subroutines won’t use every CPU register. So to optimize, the compiler needs to figure out which registers are being used, and only save those ones. In this particular bug, it appears that the compiler is doing this computation incorrectly: some registers are used by a subroutine but are not <code class="language-plaintext highlighter-rouge">push</code>ed first, leading to a corruption of the program state, which eventually results in a panic.</p><p>I actually have no idea what is causing this. I’m only able to reproduce it when I’m using the <code class="language-plaintext highlighter-rouge">heapless</code> library from inside an interrupt context, and when the subroutine I’m calling isn’t <code class="language-plaintext highlighter-rouge">inline</code>. I’m <em>pretty sure</em> this isn’t a bug with my code, but whether it’s a bug with <code class="language-plaintext highlighter-rouge">heapless</code>, <code class="language-plaintext highlighter-rouge">rustc</code>, or LLVM, I really have no idea. So I filed a bug report and decided to move on. I was initially able to work around this by manually <code class="language-plaintext highlighter-rouge">push</code>-ing the problem registers at the start of <code class="language-plaintext highlighter-rouge">add_work</code>, and <code class="language-plaintext highlighter-rouge">pop</code>-ing them at the end, but in the end I stopped using <code class="language-plaintext highlighter-rouge">heapless</code> entirely and the problem went away. Unfortunately, since I know there’s a problem but I don’t know what causes it, now every time something panics I waste a bunch of time checking to see if the register state is getting corrupted, which inevitably, it is not.</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/jA4T01RxBv77W/giphy.gif" /><figcaption>Author's depiction of the rust AVR compiler corrupting my program state</figcaption></figure></details><p>That’s a nice segue into the last thing I want to talk about in this post, but I will just briefly mention that I ended up using a bitvector to track which tasks needed awakening. I haven’t done rigorous timing estimations but I believe this is a much more efficient way to store this data, and it makes some of the code easier as well. But more about that some other time. The last thing I’m going to discuss in this post is…</p><h2 id="how-the--am-i-supposed-to-debug-anything">How the %&amp;(# am I supposed to debug anything???</h2><p>I wanted to <del>complain</del> talk a bit about the tools that I’m using, because they all suck. Mostly this is due to problems of my own making, but it’s made finding any bugs (of which I’ve had many) much harder than it needs to be. So to remind you: I’m writing code in Rust, using the Windows Subsystem for Linux 2<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote">4</a></sup>. I’m using <code class="language-plaintext highlighter-rouge">avr-gcc</code> (the WSL Ubuntu version) to compile my code, because the Windows version didn’t work. I’m using <code class="language-plaintext highlighter-rouge">avrdude</code> (the Windows version) to flash my Arduino, because a) WSL2 doesn’t have access to the USB ports, and b) when I tried using WSL1–which does have USB port access–the Linux version of <code class="language-plaintext highlighter-rouge">avrdude</code> didn’t work. I don’t actually remember why these various things did or did not work, so it’s possible that I was doing something wrong or the situation has improved somewhat. But needless to say, the situation is… non-ideal.</p><p>So anyways, my debugging process, given this setup is as follows:</p><ol><li>Flash my code and see what happens. I’ve configured my panic handler to rapidly blink the LED on the Arduino whenever the code panics, so as long as something breaks after the LED pin is enabled, I can easily tell if something’s wrong (of course, this doesn’t always happen).<li>If something’s broken and I suspect it’s in a spot where I have easy access to the <code class="language-plaintext highlighter-rouge">Usart</code> register, I use the <a href="https://docs.rs/ufmt/0.1.0/ufmt/"><code class="language-plaintext highlighter-rouge">ufmt</code></a> crate to write debug information out on the USB port. This is annoying for two reasons: 1) WSL2 doesn’t have access to the USB ports on my computer, so I have to read the data from PowerShell, and 2) for reasons I have not identified, <code class="language-plaintext highlighter-rouge">ufmt</code> sometimes causes things to panic on its own, for different reasons than whatever I’m trying to debug. The first issue is extra annoying because I haven’t figured out how to make PowerShell cleanly <em>close</em> the USB port when I’m done listening, which means I have to physically disconnect and reconnect the Arduino before I can flash any code changes. The second issue I <em>suspect</em> is due to a stack overflow, but I’ve never been able to actually isolate the problem.<li><p>If the caveman’s version of “print debugging” described in step 2 doesn’t work, I load my binary into a simulator. I have two different simulators at my disposal, Atmel Studio (running in Windows), and <a href="https://github.com/buserror/simavr"><code class="language-plaintext highlighter-rouge">simavr</code></a> (running in WSL Ubuntu, and connected up to <code class="language-plaintext highlighter-rouge">avr-gdb</code>). Both of these debuggers have good and bad things about them, which means I’m very often switching back and forth between them to try to identify issues.</p><p>First, let’s talk about Atmel Studio; you <em>can</em>, in fact, give it an ELF binary that you’ve compiled somewhere else and feed it through Atmel’s simulator, and it will even include some source code hints in its disassembler output. Moreover, you can easily see the state of the entire CPU <em>and</em> all of the external RAM at once, which makes it <em>much</em> easier to identify bugs. Unfortunately, due to (I think) some sort of WSL-&gt;Windows weirdness, it’s not able to <em>find</em> all the source files, so it’s often lacking information about where I actually <em>am</em> in the code. I also can’t set a breakpoint in the source code, I have to set breakpoints in the assembly. Couple this with the fact that it has a slightly wonky user interface, and it means the debugging experience leaves some things to be desired.</p><p>On the other hand, <code class="language-plaintext highlighter-rouge">simavr</code> plus <code class="language-plaintext highlighter-rouge">avr-gdb</code> gives a much nicer experience in some ways, since it actually knows where my source files are, and I can see the source and the assembly side-by-side, and set breakpoints in either. <code class="language-plaintext highlighter-rouge">simavr</code> also understands and can read a simulated serial port, which means the debugging information from step 2 will appear in the simulator as well (if Atmel Studio can do this, I haven’t figured out how). The downsides here are that it’s much harder to see the CPU state (I have to explicitly print it every time, instead of just having it open in a separate window), and it’s nearly <em>impossible</em> to see the values in RAM. One particularly nice feature of Atmel Studio is that it will highlight changes in memory and in the CPU state since the last breakpoint, and I have no idea how to do that in gdb, despite the fact that I think it’s a superiour debugger in almost every other way.</p></ol><p>I <em>think</em> there are probably solutions out there somewhere for most of the toolchain issues that I’ve encountered, but after a moderate amount of Googling I haven’t been able to resolve them. I’m either using the wrong search terms, or I’m an idiot, or possibly both. I would definitely love to hear about any improvements I could make in my setup going forward, though I’m hopeful that as I start moving into some higher-level logic, instead of the nitty-gritty of getting an async executor working, that debugging will get a bit easier.</p><p>In the next post in this series, I’ll air my laundry list of “random other bugs I encountered along the way”, and also talk about how I got the IR sensors on the robot working. But that’s all I’ve got for now.</p><details> <summary>click to expand</summary><figure> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://media.giphy.com/media/2KAGlmkPywhZS/giphy.gif" /><figcaption>A laundry list of bugs</figcaption></figure></details><p>Thanks for reading,</p><p>~drmorr</p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>I briefly experimented with allowing you to set timers to expire in microseconds, but this didn’t end up working very well. There were still many other bugs in the platform when I tried this, so whether it didn’t work because of other bugs or because that’s just too fine of a resolution for the Arduino to handle in a reasonable fashion I’m not quite sure. I <em>suspect</em> that the Arduino just struggles to keep up with things at that level of resolution, though.</p><p>I might come back to this in the future, but once I got everything working properly I did some really rudimentary timing analysis on my interrupts; if there are no <code class="language-plaintext highlighter-rouge">Future</code>s that need to be woken up, the ISR takes 4-5μs to complete, and if there <em>is</em> a <code class="language-plaintext highlighter-rouge">Future</code> that needs awakening, it takes more like 10-20μs, if I recall correctly. Thus it seems pretty reasonable to me that we could get stuck in an ISR when the next interrupt needs to fire, especially if we’re trying to wake something up every 30-50μs. And anyways, this was fairly consistent with the behaviour I was seeing, which was <em>extremely</em> inconsistent waking behaviour and very noticeable timing delays.</p><p>This will all become relevant when I get to talking about the infrared sensor array, which needs to delay on the order of tens of microseconds before reading. I eventually figured out a better solution for this, and decided that I didn’t want to hassle with trying to make a system work at that level of timing precision for this particular project, though I may need to for my quadcopter.</p><p>I’m also very interested in doing some profiling to see if I can optimize my ISRs any further than they already are, or maybe they’re not even worth optimizing at this point; but I think having a standard set of tools to allow me to do this kind of analysis will be useful in the future, regardless. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:2" role="doc-endnote"><p>Building the toolchain isn’t <em>too</em> difficult, but it takes a little bit of time to get correct. I more-or-less just followed the instructions on <a href="https://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.html">How to Build and Run the Compiler</a>. Since I wanted an actual “production” compiler, I built everything three times to get a “stage 2” compiler, and then also compiled the <code class="language-plaintext highlighter-rouge">core</code> library for use with my code. From there I created a custom toolchain, and then set up my environment to use my custom toolchain for Rustybot. I sadly didn’t document the entire list of steps to get this working, and it required a little bit of fiddling, but only a little bit. The only thing I still haven’t figured out is some of the “extra” tools like <code class="language-plaintext highlighter-rouge">rustfmt</code>, but I have hacked around this for now by just hardcoding a path to a different version of <code class="language-plaintext highlighter-rouge">rustfmt</code> in my config files. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:3" role="doc-endnote"><p>Are you sensing a pattern here? <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:4" role="doc-endnote"><p>The <code class="language-plaintext highlighter-rouge">2</code> will become important momentarily. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/rust/" class="post-tag no-text-decoration" >rust</a> <a href="/tags/robots/" class="post-tag no-text-decoration" >robots</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Introducing Rustybot (part 2 of n) - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Introducing Rustybot (part 2 of n) - Object Disoriented&u=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Introducing Rustybot (part 2 of n) - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/introducing-rustybot-part-2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/introducing-rustybot-part-1/">Introducing Rustybot (part 1 of n)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/rust/">rust</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/introducing-rustybot-part-1/"><div class="card-body"> <span class="timeago small" > Dec 21, 2020 <i class="unloaded">2020-12-21T23:30:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 1 of n)</h3><div class="text-muted small"><p> N.B. This is the first part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2). If you just want to skip to the source code, click here. So you want to ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/introducing-rustybot-part-1/" class="btn btn-outline-primary"><p>Introducing Rustybot (part 1 of n)</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://evokewonder.com">David R. Morrison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/rust/">rust</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://objectdisoriented.evokewonder.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
