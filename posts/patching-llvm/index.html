<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Patching LLVM and rustc" /><meta name="author" content="drmorr" /><meta property="og:locale" content="en_US" /><meta name="description" content="This post is just an aside; As I mentioned in my last post, there is a compiler bug in LLVM that is resulting in incorrect code being generated for AVR with Rust. I made some vague assertions in a footnote about “just follow the directions and you’ll be fine” because I couldn’t remember how to do it, and then I ended up having to figure out how to rebuild my toolchain today. So I’m mostly posting these instructions for my own benefit, but maybe someone else will find them useful too." /><meta property="og:description" content="This post is just an aside; As I mentioned in my last post, there is a compiler bug in LLVM that is resulting in incorrect code being generated for AVR with Rust. I made some vague assertions in a footnote about “just follow the directions and you’ll be fine” because I couldn’t remember how to do it, and then I ended up having to figure out how to rebuild my toolchain today. So I’m mostly posting these instructions for my own benefit, but maybe someone else will find them useful too." /><link rel="canonical" href="https://objectdisoriented.evokewonder.com/posts/patching-llvm/" /><meta property="og:url" content="https://objectdisoriented.evokewonder.com/posts/patching-llvm/" /><meta property="og:site_name" content="Object Disoriented" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-09T19:23:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Patching LLVM and rustc" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://objectdisoriented.evokewonder.com/posts/patching-llvm/","dateModified":"2021-01-09T19:23:00-08:00","datePublished":"2021-01-09T19:23:00-08:00","headline":"Patching LLVM and rustc","mainEntityOfPage":{"@type":"WebPage","@id":"https://objectdisoriented.evokewonder.com/posts/patching-llvm/"},"author":{"@type":"Person","name":"drmorr"},"description":"This post is just an aside; As I mentioned in my last post, there is a compiler bug in LLVM that is resulting in incorrect code being generated for AVR with Rust. I made some vague assertions in a footnote about “just follow the directions and you’ll be fine” because I couldn’t remember how to do it, and then I ended up having to figure out how to rebuild my toolchain today. So I’m mostly posting these instructions for my own benefit, but maybe someone else will find them useful too.","@context":"https://schema.org"}</script><title>Patching LLVM and rustc | Object Disoriented</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/robot.svg" alt="this robot is confused" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Object Disoriented</a></div><div class="site-subtitle font-italic">When OOP becomes OOPS</div><div class="site-about">Building robots with Rust. Navel-gazing about tech. Doing buzzwords on Kubernetes.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/drmorr0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['drmorr','evokwonder.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Patching LLVM and rustc</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Patching LLVM and rustc</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 9, 2021, 7:23 PM -0800" > Jan 9 <i class="unloaded">2021-01-09T19:23:00-08:00</i> </span> by <span class="author"> drmorr </span></div></div><div class="post-content"><p>This post is just an aside; As I mentioned in my last post, there is a compiler bug in LLVM that is resulting in incorrect code being generated for AVR with Rust. I made some vague assertions in a footnote about “just follow the directions and you’ll be fine” because I couldn’t remember how to do it, and then I ended up having to figure out how to rebuild my toolchain today. So I’m mostly posting these instructions for my own benefit, but maybe someone else will find them useful too.</p><ol><li>Download the <a href="https://reviews.llvm.org/file/data/le54xtn3ihujx3httuqp/PHID-FILE-pbdxd3wrmhhspzqev3yc/D87631.diff">patch file</a><li>If this is your first time building <code class="language-plaintext highlighter-rouge">rustc</code>, run <code class="language-plaintext highlighter-rouge">git clone https://github.com/rust-lang/rust</code>; otherwise, go into your checked-out version of Rust and <code class="language-plaintext highlighter-rouge">git pull</code>.<li><code class="language-plaintext highlighter-rouge">git submodule update --init --recursive</code><li><code class="language-plaintext highlighter-rouge">cd src/llvm-project</code><li><code class="language-plaintext highlighter-rouge">git apply patch.diff</code>, where <code class="language-plaintext highlighter-rouge">patch.diff</code> is the file you downloaded in step 1.<li><code class="language-plaintext highlighter-rouge">mkdir build &amp;&amp; cd build</code><li><code class="language-plaintext highlighter-rouge">cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release ../llvm</code><li><code class="language-plaintext highlighter-rouge">cmake --build . -- -j24</code> (or whatever number of build processes you want to run in parallel instead of 24)<li><code class="language-plaintext highlighter-rouge">cd ../../..</code><li><code class="language-plaintext highlighter-rouge">./x.py build --stage 2 library/core library/proc_macro</code><li><code class="language-plaintext highlighter-rouge">rustup toolchain link stage2 build/x86_64-unknown-linux-gnu/stage2</code></ol><p>And then you’re done! In your project directory, run <code class="language-plaintext highlighter-rouge">rustup override set stage2</code> to use the compiler you just built.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/rust/" class="post-tag no-text-decoration" >rust</a> <a href="/tags/llvm/" class="post-tag no-text-decoration" >llvm</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Patching LLVM and rustc - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/patching-llvm/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Patching LLVM and rustc - Object Disoriented&u=https://objectdisoriented.evokewonder.com/posts/patching-llvm/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Patching LLVM and rustc - Object Disoriented&url=https://objectdisoriented.evokewonder.com/posts/patching-llvm/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/introducing-rustybot-part-1/">Introducing Rustybot (part 1 of n)</a><li><a href="/posts/introducing-rustybot-part-2/">Introducing Rustybot (part 2 of n)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/llvm/">llvm</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/introducing-rustybot-part-1/"><div class="card-body"> <span class="timeago small" > Dec 21, 2020 <i class="unloaded">2020-12-21T23:30:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 1 of n)</h3><div class="text-muted small"><p> N.B. This is the first part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here. So you want ...</p></div></div></a></div><div class="card"> <a href="/posts/introducing-rustybot-part-2/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2021-01-04T23:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 2 of n)</h3><div class="text-muted small"><p> N.B. This is the second part of a series about programming an arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here. PSA: click o...</p></div></div></a></div><div class="card"> <a href="/posts/introducing-rustybot-part-3/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2021-02-26T23:31:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing Rustybot (part 3 of n)</h3><div class="text-muted small"><p> N.B. This is the third part of a series about programming an Arduino robot using Rust’s async primitives (Part 1, 2, 3). If you just want to skip to the source code, click here. Now we’re co...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/introducing-rustybot-part-2/" class="btn btn-outline-primary"><p>Introducing Rustybot (part 2 of n)</p></a> <a href="/posts/introducing-rustybot-part-3/" class="btn btn-outline-primary"><p>Introducing Rustybot (part 3 of n)</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://evokewonder.com">David R. Morrison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/robots/">robots</a> <a class="post-tag" href="/tags/llvm/">llvm</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://objectdisoriented.evokewonder.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
